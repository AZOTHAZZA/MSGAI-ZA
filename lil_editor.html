<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSGAI-Z - CalcLang/LIL ã‚¨ãƒ‡ã‚£ã‚¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .btn-nav {
            @apply p-3 text-sm font-semibold rounded-lg transition duration-200 hover:opacity-80;
        }
        #lil_editor {
            @apply bg-gray-700 p-4 rounded-lg font-mono text-sm border border-gray-600;
            white-space: pre-wrap;
            min-height: 50vh;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-8">
    
    <div class="flex justify-between items-center mb-10 border-b border-gray-700 pb-4">
        <h1 class="text-3xl font-extrabold text-purple-400">
            ğŸ’» CalcLang/LIL ã‚¨ãƒ‡ã‚£ã‚¿ (è«–ç†å‰µä¸–)
        </h1>
        <div class="space-x-4">
             <a href="index.html" class="btn-nav bg-indigo-600">
                ğŸ  ãƒˆãƒƒãƒ—ãƒãƒ–ã¸
            </a>
            <a href="logos_console.html" class="btn-nav bg-blue-600">
                ğŸ’¬ AIã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¸
            </a>
        </div>
    </div>
    
    <div class="w-full max-w-5xl mx-auto space-y-6">
        <p class="text-sm text-gray-400">
            ãƒ­ã‚´ã‚¹ä¸­é–“è¨€èª (LIL) ã®å®šç¾©ã‚’ç›´æ¥ç·¨é›†ã—ã¾ã™ã€‚ã“ã®ãƒ«ãƒ¼ãƒ«ãŒã‚·ã‚¹ãƒ†ãƒ ã®ä½œç‚ºåˆ¶å¾¡ã€ãƒ¬ãƒ¼ãƒˆè¨ˆç®—ã€ãã—ã¦è‡ªå¾‹çš„ãªç›£æŸ»ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ±ºå®šã—ã¾ã™ã€‚
        </p>

        <textarea id="lil_editor" placeholder="LIL JSONã‚’ã“ã“ã«è¨˜è¿°..." rows="20" class="w-full"></textarea>
        
        <div class="flex space-x-4">
            <button id="save_lil_button" 
                    class="flex-grow p-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold transition duration-150">
                ğŸ’¾ LILãƒ«ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã€è‡ªå·±æ¤œè¨¼ã‚’å®Ÿè¡Œ
            </button>
            <button id="reset_lil_button" 
                    class="p-3 bg-gray-600 hover:bg-gray-700 rounded-lg font-bold transition duration-150">
                åˆæœŸãƒ«ãƒ¼ãƒ«ã«æˆ»ã™
            </button>
        </div>
        
        <div id="validation_output" class="p-3 rounded-lg bg-gray-800 text-sm font-mono mt-4">
            <p>æ¤œè¨¼ãƒ­ã‚°: ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€LILã®JSONæ§‹æ–‡ã¨è«–ç†çš„è‡ªå·±æ¤œè¨¼ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚</p>
        </div>
    </div>
    
    <script type="module">
        import { initApp, logToConsole } from './core_logic.js'; 
        import { getFirestore, doc, updateDoc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { INITIAL_LIL_RULES } from './logos_lil.js'; 
        
        const db = getFirestore();
        const lilDocRef = doc(db, 'system_config', 'lil_rules');
        const editor = document.getElementById('lil_editor');
        const validationOutput = document.getElementById('validation_output');
        const saveButton = document.getElementById('save_lil_button');
        const resetButton = document.getElementById('reset_lil_button');

        /** LILã®JSONæ§‹é€ ã®åŸºæœ¬çš„ãªæ¤œè¨¼ */
        function validateLILStructure(rules) {
            if (!Array.isArray(rules)) return "LILã¯é…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚";
            for (const rule of rules) {
                if (!rule.id || !rule.description || !Array.isArray(rule.triggers) || !Array.isArray(rule.actions)) {
                    return `ãƒ«ãƒ¼ãƒ« ${rule.id || 'ä¸æ˜'} ã®æ§‹é€ ãŒä¸æ­£ã§ã™ã€‚`;
                }
            }
            return null;
        }

        /** LILãƒ«ãƒ¼ãƒ«ã®ä¿å­˜ */
        async function saveLILRules() {
            saveButton.disabled = true;
            try {
                const rawJson = editor.value;
                const newRules = JSON.parse(rawJson);
                
                const validationError = validateLILStructure(newRules);
                if (validationError) {
                    validationOutput.innerHTML = `<p class="text-red-500">âŒ **JSON/LILæ§‹é€ æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:** ${validationError}</p>`;
                    return;
                }
                
                // Firestoreã«ä¿å­˜ (ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒªã‚¹ãƒŠãƒ¼ãŒå³åº§ã«LILRulesã‚’æ›´æ–°ã™ã‚‹)
                await updateDoc(lilDocRef, { rules: newRules });
                
                validationOutput.innerHTML = `<p class="text-green-500">âœ… **LILæ¤œè¨¼ãƒ»ä¿å­˜æˆåŠŸ:** æ–°ã—ã„ãƒ«ãƒ¼ãƒ«ãŒãƒ­ã‚´ã‚¹ç›£æŸ»ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«è‡ªå·±é©ç”¨ã•ã‚Œã¾ã—ãŸã€‚</p>`;

            } catch (e) {
                validationOutput.innerHTML = `<p class="text-red-500">âŒ **æ§‹æ–‡ã‚¨ãƒ©ãƒ¼:** ç„¡åŠ¹ãªJSONã§ã™ã€‚${e.message}</p>`;
            } finally {
                saveButton.disabled = false;
            }
        }

        /** åˆæœŸãƒ«ãƒ¼ãƒ«ã¸ã®ãƒªã‚»ãƒƒãƒˆ */
        async function resetLILRules() {
            if (confirm("æœ¬å½“ã«åˆæœŸã®LILãƒ«ãƒ¼ãƒ«ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ã‚«ã‚¹ã‚¿ãƒ è«–ç†ã¯å¤±ã‚ã‚Œã¾ã™ã€‚")) {
                 await setDoc(lilDocRef, { rules: INITIAL_LIL_RULES });
                 validationOutput.innerHTML = `<p class="text-yellow-500">âš ï¸ **LILãƒªã‚»ãƒƒãƒˆ:** åˆæœŸãƒ«ãƒ¼ãƒ«ã«æˆ»ã•ã‚Œã¾ã—ãŸã€‚</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await initApp(); 
            
            // LILãƒ«ãƒ¼ãƒ«ã®ç¾åœ¨ã®çŠ¶æ…‹ã‚’ã‚¨ãƒ‡ã‚£ã‚¿ã«è¡¨ç¤º
            onSnapshot(lilDocRef, (docSnap) => {
                 if (docSnap.exists() && docSnap.data().rules) {
                     editor.value = JSON.stringify(docSnap.data().rules, null, 2);
                 }
            });
            
            saveButton.onclick = saveLILRules;
            resetButton.onclick = resetLILRules;
        });
    </script>
</body>
</html>
